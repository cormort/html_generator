<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTML 產生器 (專業版) - 含 Markdown</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/material.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/dracula.min.css">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/lint/lint.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/fold/foldgutter.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/dialog/dialog.css">

    <style>
        /* CSS 變數定義 (與前一版相同) */
        :root {
            --bg-color: #f8f9fa;
            --text-color: #343a40;
            --container-bg: #ffffff;
            --container-shadow: rgba(0, 0, 0, 0.08);
            --heading-color: #2c3e50;
            --button-primary-bg: #4a6785;
            --button-primary-hover: #3a536b;
            --button-check-bg: #28a745;
            --button-check-hover: #218838;
            --button-danger-bg: #dc3545;
            --button-danger-hover: #c82333;
            --cm-border-color: #ced4da;
            --cm-focus-border: #8ab4f8;
            --cm-focus-shadow: rgba(74, 103, 133, 0.25);
            --selector-bg: #ffffff;
            --selector-border: #ced4da;
            --preview-border: #ced4da;
        }

        [data-theme="material"] {
            --bg-color: #263238;
            --text-color: #ECEFF1;
            --container-bg: #37474F;
            --container-shadow: rgba(0, 0, 0, 0.25);
            --heading-color: #ffffff;
            --button-primary-bg: #009688;
            --button-primary-hover: #00796B;
            --button-check-bg: #4CAF50;
            --button-check-hover: #43A047;
            --button-danger-bg: #f44336;
            --button-danger-hover: #e53935;
            --cm-border-color: #546E7A;
            --cm-focus-border: #80CBC4;
            --cm-focus-shadow: rgba(128, 203, 196, 0.25);
            --selector-bg: #546E7A;
            --selector-border: #546E7A;
            --preview-border: #546E7A;
        }

        [data-theme="dracula"] {
            --bg-color: #282a36;
            --text-color: #f8f8f2;
            --container-bg: #3b3d50;
            --container-shadow: rgba(0, 0, 0, 0.25);
            --heading-color: #bd93f9;
            --button-primary-bg: #bd93f9;
            --button-primary-hover: #a47de4;
            --button-check-bg: #50fa7b;
            --button-check-hover: #42e368;
            --button-danger-bg: #ff5555;
            --button-danger-hover: #ff2d2d;
            --cm-border-color: #6272a4;
            --cm-focus-border: #bd93f9;
            --cm-focus-shadow: rgba(189, 147, 249, 0.25);
            --selector-bg: #6272a4;
            --selector-border: #6272a4;
            --preview-border: #6272a4;
        }

        /* 全局樣式 (與前一版相同) */
        html, body {
            height: 100%;
            margin: 0;
            overflow: hidden; 
        }
                
        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', 'PingFang TC', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s, color 0.3s;
        }

        /* 頂部標題列樣式 (與前一版相同) */
        .header-bar {
            padding: 10px 20px;
            background-color: var(--container-bg);
            box-shadow: 0 4px 12px var(--container-shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }
        .header-bar h1 {
            font-size: 1.5rem;
            color: var(--heading-color);
            margin: 0;
        }
        #theme-select {
            padding: 5px 8px;
            border-radius: 4px;
            border: 1px solid var(--selector-border);
            background-color: var(--selector-bg);
            color: var(--text-color);
            font-size: 0.9rem;
        }

        /* 主內容分割佈局 (與前一版相同) */
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr; /* 左右 50% 分割 */
            flex-grow: 1; /* 佔滿剩餘空間 */
            overflow: hidden;
            height: 100%;
        }
                
        .editor-pane, .preview-pane {
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
                
        .button-container {
            text-align: center;
            padding: 10px 0;
            background-color: var(--container-bg);
            border-bottom: 1px solid var(--cm-border-color);
            border-top: 1px solid var(--cm-border-color);
            /* (新增) 讓按鈕和 Checkbox 垂直對齊 */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* (修改) 讓按鈕在 Flex 容器中保持原樣 */
        .button-container button {
             /* 移除 margin: auto 或其他，使用原始 margin */
        }

        /* (修改) 讓 Label 也在 Flex 容器中 */
        .preview-pane .button-container label {
            margin: 5px; /* 統一間距 */
        }


        button {
            padding: 8px 18px;
            font-size: 0.95rem;
            cursor: pointer;
            margin: 5px;
            border: none;
            border-radius: 6px;
            color: white;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease;
        }

        /* CodeMirror 和預覽視窗樣式 (與前一版相同) */
        .CodeMirror {
            border: none;
            height: 100%;
            font-size: 1rem;
            flex-grow: 1;
        }

        #preview-frame {
            width: 100%;
            height: 100%;
            border: none;
            background-color: #ffffff;
            flex-grow: 1;
        }

        /* 按鈕樣式 (與前一版相同) */
        button:not(#clearButton):not(#checkButton):not(#formatButton) { background-color: var(--button-primary-bg); }
        button:not(#clearButton):not(#checkButton):not(#formatButton):hover { background-color: var(--button-primary-hover); transform: translateY(-1px); }
        #checkButton { background-color: var(--button-check-bg); }
        #checkButton:hover { background-color: var(--button-check-hover); transform: translateY(-1px); }
        #clearButton { background-color: var(--button-danger-bg); }
        #clearButton:hover { background-color: var(--button-danger-hover); transform: translateY(-1px); }
        button:active { transform: translateY(0px); }

        #formatButton {
            background-color: #6272a4; 
        }
        [data-theme="material"] #formatButton {
            background-color: #00BCD4;
        }
        #formatButton:hover {
            opacity: 0.8;
            transform: translateY(-1px);
        }

        /* CodeMirror 搜尋對話框樣式 (與前一版相同) */
        .CodeMirror-dialog {
            background-color: var(--container-bg);
            color: var(--text-color);
            border-color: var(--cm-border-color);
            padding: 5px;
            box-shadow: 0 2px 8px var(--container-shadow);
        }
        .CodeMirror-dialog input {
            background-color: var(--bg-color);
            color: var(--text-color);
            border: 1px solid var(--cm-border-color);
            padding: 3px;
        }
        .CodeMirror-search-field {
            width: 20em;
        }
    </style>
</head>
<body>

    <div class="header-bar">
        <h1>HTML / Markdown 產生器 (專業版)</h1>
        <div class="theme-selector-container">
            <label for="theme-select">選擇主題: </label>
            <select id="theme-select" onchange="applyTheme(this.value)">
                <option value="default-light">預設淺色 (Default Light)</option>
                <option value="material">Material (Dark)</option>
                <option value="dracula">Dracula (Dark)</option>
            </select>
        </div>
    </div>

    <div class="main-content">
        <div class="editor-pane">
            <div class="button-container">
                <button type="button" id="formatButton" onclick="formatCode()">美化格式 (HTML)</button>
                <button type="button" id="checkButton" onclick="checkSyntax()">檢查語法 (HTML)</button>
                <button type="button" onclick="downloadHTML()">下載檔案</button>
                <button type="button" id="clearButton" onclick="clearContent()">清除內容</button>
            </div>
            <textarea id="htmlSource" placeholder="貼上您的 HTML 或 Markdown 原始碼..."></textarea>
        </div>

        <div class="preview-pane">
            <div class="button-container">
                <label style="font-weight: bold;">即時預覽</label>
                
                <label for="markdown-toggle" style="font-weight: normal; font-size: 0.9rem; cursor: pointer; user-select: none;">
                    <input type="checkbox" id="markdown-toggle" onchange="triggerUpdate()">
                    Markdown 模式
                </label>
            </div>
            <iframe id="preview-frame" title="即時預覽"></iframe>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/dialog/dialog.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/search/searchcursor.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/search/search.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/search/jump-to-line.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jshint/2.13.6/jshint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/lint/javascript-lint.js"></script>
    <script src="https://unpkg.com/htmlhint@latest/lib/htmlhint.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/lint/html-lint.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/lint/lint.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/htmlmixed/htmlmixed.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/edit/closetag.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/edit/closebrackets.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/fold/foldcode.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/fold/foldgutter.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/fold/brace-fold.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/fold/xml-fold.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/fold/tag-fold.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/fold/comment-fold.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.14.7/beautify-html.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>


    <script>
        // 初始化 CodeMirror 編輯器 (與你原本的設定相同)
        var editor = CodeMirror.fromTextArea(document.getElementById('htmlSource'), {
            mode: "htmlmixed",
            theme: "default",
            lineNumbers: true,
            lineWrapping: true,
            lint: true,
            autoCloseTags: true,
            autoCloseBrackets: true,
            foldGutter: true,
            gutters: ["CodeMirror-linenumbers", "CodeMirror-lint-markers", "CodeMirror-foldgutter"],
            extraKeys: {
                "Ctrl-F": "find",
                "Cmd-F": "find", // for Mac
                "Ctrl-H": "replace",
                "Cmd-Alt-F": "replace", // for Mac
                "Shift-Ctrl-H": "replaceAll",
                "Shift-Cmd-Alt-F": "replaceAll" // for Mac
            }
        });

        // *** (新增) 獲取 Markdown 切換開關的 DOM 元素 ***
        var markdownToggle = document.getElementById('markdown-toggle');

        // *** (已修改) 即時預覽函式 ***
        function updatePreview() {
            // 1. 檢查 "Markdown 模式" 是否開啟
            var isMarkdownMode = markdownToggle.checked;
            
            // 2. 獲取編輯器原始內容
            var rawContent = editor.getValue();
            var processedContent = '';

            // 3. 根據模式決定如何處理內容
            if (isMarkdownMode) {
                // *** Markdown 模式 ***
                if (typeof marked === 'undefined') {
                    processedContent = '<h1>錯誤：marked.js 函式庫載入失敗！</h1><p>請檢查網路連線並重新整理。</p>';
                } else {
                    // 使用 marked.js 解析
                    processedContent = marked.parse(rawContent);
                }
            } else {
                // *** HTML 模式 (原始功能) ***
                processedContent = rawContent;
            }

            // 4. 更新預覽
            var iframe = document.getElementById('preview-frame');
            iframe.srcdoc = processedContent;
        }

        // *** (已修改) 防抖 (Debounce) 邏輯 ***
        var updateTimeout;
        // 建立一個手動觸發器，以便在切換 Toggle 時也能更新
        function triggerUpdate() {
            clearTimeout(updateTimeout);
            updateTimeout = setTimeout(updatePreview, 300); // 延遲 300 毫秒後更新
        }
        
        // 監聽編輯器變更事件，觸發即時預覽
        editor.on("change", triggerUpdate);

        // 程式碼美化函式 (與你原本的相同)
        function formatCode() {
            // 在 Markdown 模式下，美化功能可能無效或產生非預期結果
            if (markdownToggle.checked) {
                alert("「美化格式」功能僅適用於 HTML 模式。");
                return;
            }
            try {
                var currentCode = editor.getValue();
                var formattedCode = html_beautify(currentCode, {
                    "indent_size": 4, "indent_char": " ", "max_preserve_newlines": 1,
                    "preserve_newlines": true, "indent_scripts": "normal",
                    "brace_style": "collapse", "wrap_line_length": 0, "indent_inner_html": true
                });
                editor.setValue(formattedCode);
            } catch (e) {
                console.error("程式碼美化失敗:", e);
                alert("程式碼美化失敗，請檢查主控台獲取更多資訊。");
            }
        }

        // 主題切換函式 (與你原本的相同)
        function applyTheme(themeName) {
            let cmTheme = 'default';
            if (themeName === 'default-light') {
                document.body.removeAttribute('data-theme');
                cmTheme = 'default';
            } else {
                document.body.dataset.theme = themeName;
                cmTheme = themeName;
            }
            editor.setOption('theme', cmTheme);
        }

        // 語法檢查函式 (與你原本的相同)
        function checkSyntax() {
            // 語法檢查僅適用於 HTML
            if (markdownToggle.checked) {
                alert("「檢查語法」功能僅適用於 HTML 模式。");
                return;
            }
            editor.performLint();
            alert("語法檢查已執行完畢！請查看編輯器左側的錯誤標記（如果有的話）。");
        }

        // *** (新增) 用於 Markdown 下載的輔助函式 ***
        function createHtmlTemplate(content, title = "Markdown 匯出") {
            return `
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${title}</title>
    <style>
        /* 為 Markdown 匯出內容加入一些基本樣式 */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6; padding: 20px; max-width: 800px; margin: 0 auto; color: #333;
        }
        h1, h2, h3, h4, h5, h6 { border-bottom: 1px solid #eee; padding-bottom: 5px; }
        ul, ol { padding-left: 30px; }
        code { background-color: #f4f4f4; padding: 2px 6px; border-radius: 4px; font-family: monospace; }
        pre { background-color: #f4f4f4; padding: 10px; border-radius: 4px; overflow-x: auto; }
        img { max-width: 100%; height: auto; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ddd; padding: 8px; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>
    ${content}
</body>
</html>
            `;
        }

        // *** (已修改) 下載 HTML 函式 ***
        function downloadHTML() {
            var isMarkdownMode = markdownToggle.checked;
            var rawContent = editor.getValue();
            var finalHtmlContent = '';

            if (isMarkdownMode) {
                // *** Markdown 模式 ***
                // 下載時，將 Markdown 轉換並打包成一個完整的、帶有樣式的 HTML 檔案
                if (typeof marked === 'undefined') {
                    alert('marked.js 載入失敗，無法下載。');
                    return;
                }
                var convertedBody = marked.parse(rawContent);
                // 使用輔助函式來建立完整的 HTML 頁面
                finalHtmlContent = createHtmlTemplate(convertedBody, "Markdown 匯出內容");
            } else {
                // *** HTML 模式 ***
                // 直接使用編輯器中的 HTML 內容
                finalHtmlContent = rawContent;
            }

            // 下載邏輯 (與你原本的相同)
            var blob = new Blob([finalHtmlContent], { type: 'text/html' });
            var a = document.createElement('a');
            a.style.display = 'none';
            var url = window.URL.createObjectURL(blob);
            a.href = url;
            a.download = 'generated.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // 清除內容函式 (與你原本的相同)
        function clearContent() {
            editor.setValue('');
        }

        // 頁面載入時觸發一次預覽
        document.addEventListener("DOMContentLoaded", updatePreview);

    </script>
</body>
</html>
