<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTML 產生器 (專業版)</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.css">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/material.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/dracula.min.css">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/lint/lint.css">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/fold/foldgutter.css">

    <style>
        /* CSS 變數定義 (與前一版相同) */
        :root {
            --bg-color: #f8f9fa;
            --text-color: #343a40;
            --container-bg: #ffffff;
            --container-shadow: rgba(0, 0, 0, 0.08);
            --heading-color: #2c3e50;
            --button-primary-bg: #4a6785;
            --button-primary-hover: #3a536b;
            --button-check-bg: #28a745;
            --button-check-hover: #218838;
            --button-danger-bg: #dc3545;
            --button-danger-hover: #c82333;
            --cm-border-color: #ced4da;
            --cm-focus-border: #8ab4f8;
            --cm-focus-shadow: rgba(74, 103, 133, 0.25);
            --selector-bg: #ffffff;
            --selector-border: #ced4da;
            --preview-border: #ced4da;
        }

        [data-theme="material"] {
            --bg-color: #263238;
            --text-color: #ECEFF1;
            --container-bg: #37474F;
            --container-shadow: rgba(0, 0, 0, 0.25);
            --heading-color: #ffffff;
            --button-primary-bg: #009688;
            --button-primary-hover: #00796B;
            --button-check-bg: #4CAF50;
            --button-check-hover: #43A047;
            --button-danger-bg: #f44336;
            --button-danger-hover: #e53935;
            --cm-border-color: #546E7A;
            --cm-focus-border: #80CBC4;
            --cm-focus-shadow: rgba(128, 203, 196, 0.25);
            --selector-bg: #546E7A;
            --selector-border: #546E7A;
            --preview-border: #546E7A;
        }

        [data-theme="dracula"] {
            --bg-color: #282a36;
            --text-color: #f8f8f2;
            --container-bg: #3b3d50;
            --container-shadow: rgba(0, 0, 0, 0.25);
            --heading-color: #bd93f9;
            --button-primary-bg: #bd93f9;
            --button-primary-hover: #a47de4;
            --button-check-bg: #50fa7b;
            --button-check-hover: #42e368;
            --button-danger-bg: #ff5555;
            --button-danger-hover: #ff2d2d;
            --cm-border-color: #6272a4;
            --cm-focus-border: #bd93f9;
            --cm-focus-shadow: rgba(189, 147, 249, 0.25);
            --selector-bg: #6272a4;
            --selector-border: #6272a4;
            --preview-border: #6272a4;
        }

        /* 2. (修改) 全局樣式以支援全螢幕佈局 */
        html, body {
            height: 100%;
            margin: 0;
            overflow: hidden; /* 避免根層級滾動 */
        }
        
        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', 'PingFang TC', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            display: flex; /* 使用 Flexbox 進行佈局 */
            flex-direction: column; /* 垂直排列：標題 -> 內容 */
            transition: background-color 0.3s, color 0.3s;
        }

        /* 3. (修改) 頂部標題列樣式 */
        .header-bar {
            padding: 10px 20px;
            background-color: var(--container-bg);
            box-shadow: 0 4px 12px var(--container-shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }
        .header-bar h1 {
            font-size: 1.5rem;
            color: var(--heading-color);
            margin: 0;
        }
        
        .theme-selector-container {
            /* (移除 text-align: right 和 margin-bottom) */
        }
        #theme-select {
            padding: 5px 8px;
            border-radius: 4px;
            border: 1px solid var(--selector-border);
            background-color: var(--selector-bg);
            color: var(--text-color);
            font-size: 0.9rem;
        }

        /* 4. (新增) 主內容分割佈局 (CSS Grid) */
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr; /* 左右 50% 分割 */
            flex-grow: 1; /* 佔滿剩餘空間 */
            overflow: hidden;
            height: 100%; /* 確保高度正確 */
        }
        
        .editor-pane, .preview-pane {
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .button-container {
            text-align: center;
            padding: 10px 0;
            background-color: var(--container-bg);
            border-bottom: 1px solid var(--cm-border-color); /* 統一風格 */
            border-top: 1px solid var(--cm-border-color);
        }

        button {
            padding: 8px 18px; /* 稍微縮小按鈕以適應頂部 */
            font-size: 0.95rem;
            cursor: pointer;
            margin: 5px;
            border: none;
            border-radius: 6px;
            color: white;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease;
        }
        
        /* 5. (修改) CodeMirror 和預覽視窗樣式 */
        .CodeMirror {
            border: none; /* 移除邊框，由父容器控制 */
            height: 100%; /* 佔滿父容器 */
            font-size: 1rem;
            flex-grow: 1; /* 佔滿剩餘空間 */
        }
        .CodeMirror:focus-within {
             /* (移除邊框和陰影，保持簡潔) */
        }

        #preview-frame {
            width: 100%;
            height: 100%;
            border: none;
            background-color: #ffffff; /* 預覽區域始終為白色背景 */
            flex-grow: 1;
        }
        
        /* 按鈕樣式 (繼承自上一版) */
        button:not(#clearButton):not(#checkButton):not(#formatButton) { background-color: var(--button-primary-bg); }
        button:not(#clearButton):not(#checkButton):not(#formatButton):hover { background-color: var(--button-primary-hover); transform: translateY(-1px); }
        #checkButton { background-color: var(--button-check-bg); }
        #checkButton:hover { background-color: var(--button-check-hover); transform: translateY(-1px); }
        #clearButton { background-color: var(--button-danger-bg); }
        #clearButton:hover { background-color: var(--button-danger-hover); transform: translateY(-1px); }
        button:active { transform: translateY(0px); }

        /* 6. (新增) 美化按鈕樣式 */
        #formatButton {
            background-color: #6272a4; /* Dracula Purple 變種 */
        }
        [data-theme="material"] #formatButton {
            background-color: #00BCD4; /* Material Cyan */
        }
        #formatButton:hover {
            opacity: 0.8;
            transform: translateY(-1px);
        }
    </style>
</head>
<body>

    <div class="header-bar">
        <h1>HTML 產生器 (專業版)</h1>
        <div class="theme-selector-container">
            <label for="theme-select">選擇主題: </label>
            <select id="theme-select" onchange="applyTheme(this.value)">
                <option value="default-light">預設淺色 (Default Light)</option>
                <option value="material">Material (Dark)</option>
                <option value="dracula">Dracula (Dark)</option>
            </select>
        </div>
    </div>

    <div class="main-content">
        <div class="editor-pane">
            <div class="button-container">
                <button type="button" id="formatButton" onclick="formatCode()">美化格式</button>
                <button type="button" id="checkButton" onclick="checkSyntax()">檢查語法</button>
                <button type="button" onclick="downloadHTML()">下載 HTML</button>
                <button type="button" id="clearButton" onclick="clearContent()">清除內容</button>
            </div>
            <textarea id="htmlSource" placeholder="在這裡貼上您的 HTML 原始碼..."></textarea>
        </div>

        <div class="preview-pane">
            <div class="button-container">
                <label style="font-weight: bold;">即時預覽</label>
            </div>
            <iframe id="preview-frame" title="即時預覽"></iframe>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jshint/2.13.6/jshint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/lint/javascript-lint.js"></script>
    <script src="https://unpkg.com/htmlhint@latest/lib/htmlhint.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/lint/html-lint.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/lint/lint.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/htmlmixed/htmlmixed.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/edit/closetag.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/edit/closebrackets.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/fold/foldcode.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/fold/foldgutter.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/fold/brace-fold.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/fold/xml-fold.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/fold/tag-fold.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/fold/comment-fold.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.14.7/beautify-html.min.js"></script>


    <script>
        // 10. (修改) 初始化 CodeMirror 編輯器 (加入 Addons)
        var editor = CodeMirror.fromTextArea(document.getElementById('htmlSource'), {
            mode: "htmlmixed",
            theme: "default",
            lineNumbers: true,
            lineWrapping: true,
            
            // 語法檢查設定
            lint: true,
            
            // (新增) 編輯器增強功能
            autoCloseTags: true,
            autoCloseBrackets: true,
            
            // (新增) 程式碼摺疊設定
            foldGutter: true,
            gutters: ["CodeMirror-linenumbers", "CodeMirror-lint-markers", "CodeMirror-foldgutter"]
        });

        // 11. (新增) 即時預覽函式
        function updatePreview() {
            var htmlContent = editor.getValue();
            var iframe = document.getElementById('preview-frame');
            
            // 使用 srcdoc 屬性來更新 iframe，這是最安全且推薦的方式
            // 它會自動建立一個完整的 HTML 文件上下文
            iframe.srcdoc = htmlContent;
        }

        // 12. (新增) 監聽編輯器變更事件，觸發即時預覽
        // 使用 setTimeout 進行防抖(debounce)，避免過於頻繁的更新
        var updateTimeout;
        editor.on("change", function() {
            clearTimeout(updateTimeout);
            updateTimeout = setTimeout(updatePreview, 300); // 延遲 300 毫秒後更新
        });

        // 13. (新增) 程式碼美化函式
        function formatCode() {
            try {
                var currentCode = editor.getValue();
                // 使用 html_beautify 函式
                var formattedCode = html_beautify(currentCode, {
                    "indent_size": 4,
                    "indent_char": " ",
                    "max_preserve_newlines": 1,
                    "preserve_newlines": true,
                    "keep_array_indentation": false,
                    "break_chained_methods": false,
                    "indent_scripts": "normal",
                    "brace_style": "collapse",
                    "space_before_conditional": true,
                    "unescape_strings": false,
                    "jslint_happy": false,
                    "end_with_newline": false,
                    "wrap_line_length": 0,
                    "indent_inner_html": true,
                    "comma_first": false,
                    "e4x": false,
                    "indent_empty_lines": false
                });
                
                // 將格式化後的程式碼寫回編輯器
                editor.setValue(formattedCode);
            } catch (e) {
                console.error("程式碼美化失敗:", e);
                alert("程式碼美化失敗，請檢查主控台獲取更多資訊。");
            }
        }


        // (以下函式大多不變，除了 'previewHTML' 已被移除)

        function applyTheme(themeName) {
            let cmTheme = 'default';
            if (themeName === 'default-light') {
                document.body.removeAttribute('data-theme');
                cmTheme = 'default';
            } else {
                document.body.dataset.theme = themeName;
                cmTheme = themeName; 
            }
            editor.setOption('theme', cmTheme);
        }

        function checkSyntax() {
            editor.performLint();
            alert("語法檢查已執行完畢！請查看編輯器左側的錯誤標記（如果有的話）。");
        }

        // 'previewHTML' 函式已被 'updatePreview' 和 iframe 取代，故刪除。

        function downloadHTML() {
            var htmlContent = editor.getValue();
            var blob = new Blob([htmlContent], { type: 'text/html' });
            var a = document.createElement('a');
            a.style.display = 'none';
            var url = window.URL.createObjectURL(blob);
            a.href = url;
            a.download = 'generated.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        function clearContent() {
            editor.setValue('');
        }
        
        // 14. (新增) 頁面載入時觸發一次預覽
        document.addEventListener("DOMContentLoaded", updatePreview);

    </script>

</body>
</html>
